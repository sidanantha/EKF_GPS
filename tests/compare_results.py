"""
Compare EKF/MEKF Estimates with Ground Truth
=============================================

This script loads the filter estimates from main.py and compares them
with the ground truth data generated by test_EKF_MEKF.py.
Generates comparison plots showing estimated vs true values and errors.
"""

import sys
import os
import numpy as np
from pyquaternion import Quaternion

# Add parent directory to path
sys.path.insert(0, os.path.join(os.path.dirname(__file__), '..'))

from data_processing.plotdata_true import (plot_positions_comparison,
                                           plot_attitude_comparison,
                                           plot_estimation_errors,
                                           quaternion_to_euler)


def load_ground_truth(test_name, ground_truth_dir='simulated_ground_truth'):
    """
    Load ground truth data saved by test_EKF_MEKF.py.
    
    Args:
        test_name: Name of test (e.g., 'linear_motion')
        ground_truth_dir: Directory containing ground truth numpy files
    
    Returns:
        Dictionary with position_truth, velocity_truth, acceleration_truth,
        attitude_truth (as list of Quaternions), time vector
    """
    try:
        position_truth = np.load(f'{ground_truth_dir}/{test_name}_position_truth.npy')
        velocity_truth = np.load(f'{ground_truth_dir}/{test_name}_velocity_truth.npy')
        acceleration_truth = np.load(f'{ground_truth_dir}/{test_name}_acceleration_truth.npy')
        
        # Load attitude truth and convert back to Quaternion objects
        quat_array = np.load(f'{ground_truth_dir}/{test_name}_attitude_truth.npy')
        attitude_truth = [Quaternion(w=q[0], x=q[1], y=q[2], z=q[3]) for q in quat_array]
        
        time_vec = np.load(f'{ground_truth_dir}/{test_name}_time.npy')
        
        return {
            'position_truth': position_truth,
            'velocity_truth': velocity_truth,
            'acceleration_truth': acceleration_truth,
            'attitude_truth': attitude_truth,
            'time': time_vec,
        }
    except Exception as e:
        print(f"Error loading ground truth data: {e}")
        return None


def load_estimates(test_name, results_base_dir='results'):
    """
    Load filter estimates saved by main.py.
    
    Args:
        test_name: Name of test (e.g., 'linear_motion')
        results_base_dir: Base directory containing test-specific result subdirectories
    
    Returns:
        Dictionary with ekf_estimates (9xN), mekf_quaternions (list), covariances
    """
    try:
        # Load from test-specific subdirectory
        results_dir = f'{results_base_dir}/{test_name}'
        ekf_estimates = np.load(f'{results_dir}/ekf_position_estimates.npy')
        mekf_cov = np.load(f'{results_dir}/mekf_covariance.npy')
        ekf_cov = np.load(f'{results_dir}/ekf_covariance.npy')
        
        # Load MEKF quaternions from text file
        mekf_quaternions = []
        with open(f'{results_dir}/mekf_quaternions.txt', 'r') as f:
            lines = f.readlines()
            for line in lines[1:]:  # Skip header
                try:
                    parts = line.strip().split(',')
                    w, x, y, z = float(parts[1]), float(parts[2]), float(parts[3]), float(parts[4])
                    mekf_quaternions.append(Quaternion(w=w, x=x, y=y, z=z))
                except:
                    pass
        
        return {
            'ekf_estimates': ekf_estimates,
            'mekf_quaternions': mekf_quaternions,
            'ekf_covariance': ekf_cov,
            'mekf_covariance': mekf_cov,
        }
    except Exception as e:
        print(f"Error loading estimates: {e}")
        return None


def compute_errors(ekf_estimates, ground_truth, mekf_quaternions, attitude_truth):
    """
    Compute position and attitude errors.
    
    Args:
        ekf_estimates: 9xN array of EKF state estimates
        ground_truth: Dictionary with truth data
        mekf_quaternions: List of estimated quaternions
        attitude_truth: List of true quaternions
    
    Returns:
        Dictionary with position_error, attitude_error, RMSE values
    """
    # EKF position error (first 3 states)
    ekf_pos = ekf_estimates[0:3, :]
    pos_error = ekf_pos - ground_truth['position_truth']
    pos_rmse = np.sqrt(np.mean(np.sum(pos_error**2, axis=0)))
    
    # EKF velocity error
    ekf_vel = ekf_estimates[3:6, :]
    vel_error = ekf_vel - ground_truth['velocity_truth']
    vel_rmse = np.sqrt(np.mean(np.sum(vel_error**2, axis=0)))
    
    # EKF acceleration error
    ekf_accel = ekf_estimates[6:9, :]
    accel_error = ekf_accel - ground_truth['acceleration_truth']
    accel_rmse = np.sqrt(np.mean(np.sum(accel_error**2, axis=0)))
    
    # MEKF attitude error (quaternion distance)
    attitude_errors = []
    for i, q_est in enumerate(mekf_quaternions):
        q_true = attitude_truth[i]
        # Quaternion error: angle between true and estimated
        q_err = q_true.inverse * q_est
        angle_err = 2 * np.arccos(np.clip(abs(q_err.w), -1, 1))  # rad
        attitude_errors.append(np.degrees(angle_err))  # Convert to degrees
    
    attitude_rmse = np.sqrt(np.mean(np.array(attitude_errors)**2))
    
    return {
        'position_error': pos_error,
        'position_rmse': pos_rmse,
        'velocity_error': vel_error,
        'velocity_rmse': vel_rmse,
        'acceleration_error': accel_error,
        'acceleration_rmse': accel_rmse,
        'attitude_error': np.array(attitude_errors),
        'attitude_rmse': attitude_rmse,
    }


def print_comparison_summary(test_name, errors):
    """Print summary of errors."""
    print("\n" + "="*70)
    print(f"COMPARISON RESULTS: {test_name.upper().replace('_', ' ')}")
    print("="*70)
    
    print("\n" + "-"*70)
    print("POSITION ESTIMATION")
    print("-"*70)
    print(f"Position RMSE:     {errors['position_rmse']:.4f} m")
    print(f"Velocity RMSE:     {errors['velocity_rmse']:.4f} m/s")
    print(f"Acceleration RMSE: {errors['acceleration_rmse']:.4f} m/s²")
    
    print("\n" + "-"*70)
    print("ATTITUDE ESTIMATION")
    print("-"*70)
    print(f"Attitude RMSE:     {errors['attitude_rmse']:.4f} degrees")
    print(f"Max Attitude Error: {np.max(errors['attitude_error']):.4f} degrees")
    print(f"Min Attitude Error: {np.min(errors['attitude_error']):.4f} degrees")


def main():
    """
    Compare estimates with ground truth for all test scenarios.
    """
    print("\n" + "="*70)
    print("COMPARISON: ESTIMATES vs GROUND TRUTH")
    print("="*70)
    
    test_scenarios = ['linear_motion', 'circular_motion', 'helical_motion']
    
    for test_name in test_scenarios:
        print(f"\n\nProcessing: {test_name.upper().replace('_', ' ')}")
        print("-"*70)
        
        # Load data
        ground_truth = load_ground_truth(test_name)
        estimates = load_estimates(test_name)
        
        if ground_truth is None or estimates is None:
            print(f"✗ Skipping {test_name}: Missing data files")
            print(f"  Make sure to run:")
            print(f"    1. python tests/test_EKF_MEKF.py  (generates ground truth)")
            print(f"    2. python main.py  (generates estimates)")
            continue
        
        # Compute errors
        errors = compute_errors(estimates['ekf_estimates'], ground_truth,
                               estimates['mekf_quaternions'], ground_truth['attitude_truth'])
        
        # Print summary
        print_comparison_summary(test_name, errors)
        
        # Create comparison plots
        print(f"\nGenerating comparison plots for {test_name}...")
        save_dir = f'test_results/{test_name}_comparison'
        os.makedirs(save_dir, exist_ok=True)
        
        try:
            # Plot: Estimated vs True positions
            print("  - Position comparison...")
            plot_positions_comparison(estimates['ekf_estimates'][0:3, :],
                                    ground_truth['position_truth'],
                                    save_dir=save_dir, show=False)
            
            # Plot: Estimated vs True attitudes
            print("  - Attitude comparison...")
            plot_attitude_comparison(estimates['mekf_quaternions'],
                                    ground_truth['attitude_truth'],
                                    save_dir=save_dir, show=False)
            
            # Plot: Estimation errors
            print("  - Estimation errors...")
            plot_estimation_errors(estimates['ekf_estimates'][0:3, :],
                                 ground_truth['position_truth'],
                                 estimates['mekf_quaternions'],
                                 ground_truth['attitude_truth'],
                                 save_dir=save_dir, show=False)
            
            print(f"✓ Plots saved to: {save_dir}/")
            
        except Exception as e:
            print(f"✗ Error generating plots: {e}")
    
    print("\n" + "="*70)
    print("COMPARISON COMPLETE")
    print("="*70 + "\n")


if __name__ == "__main__":
    main()

